<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Cassino Trade</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:      #06070b;
      --surface: #0c0e15;
      --card:    #101420;
      --border:  #1c2035;
      --gold:    #22c063;
      --green:   #00e57a;
      --red:     #ff3d5a;
      --blue:    #4d8fff;
      --text:    #dde0f0;
      --muted:   #485070;
      --r: 14px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; background: var(--bg); }
    body { font-family: 'Outfit', sans-serif; color: var(--text); font-size: 15px; }

    /* AUTH WRAP ‚Äî scrollable so long signup form fits on small screens */
    #authWrap { position: fixed; inset: 0; z-index: 500; background: var(--bg); display: flex; align-items: flex-start; justify-content: center; padding: 24px; overflow-y: auto; }
    #appShell { display: none; position: fixed; inset: 0; flex-direction: column; }
    #appShell.show { display: flex; }

    .view { display: none; flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: 80px; }
    .view.active { display: block; }

    /* ‚îÄ‚îÄ AUTH STYLES ‚îÄ‚îÄ */
    .auth-box { width: 100%; max-width: 370px; padding-top: 16px; }
    .auth-logo { font-family: 'Syne', sans-serif; font-size: 36px; font-weight: 800; text-align: center; color: var(--gold); margin-bottom: 4px; letter-spacing: 1px; }
    .auth-sub  { text-align: center; color: var(--muted); font-size: 13px; margin-bottom: 32px; }
    .tab-row   { display: grid; grid-template-columns: 1fr 1fr; background: var(--surface); border-radius: 12px; padding: 4px; gap: 4px; margin-bottom: 24px; }
    .tab-btn   { padding: 10px; border: none; background: transparent; color: var(--muted); font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; border-radius: 9px; cursor: pointer; transition: all .2s; }
    .tab-btn.on { background: var(--gold); color: #000; }
    .f         { margin-bottom: 14px; }
    .f label   { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 7px; }
    .f input   { width: 100%; background: var(--surface); border: 1.5px solid var(--border); border-radius: 11px; padding: 13px 16px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 15px; outline: none; transition: border-color .2s; }
    .f input:focus { border-color: var(--gold); }
    /* Small hint text shown below a field */
    .f-hint { font-size: 11px; color: var(--muted); margin-top: 5px; padding-left: 2px; }
    .err-box   { background: rgba(255,61,90,.1); color: var(--red); border: 1px solid rgba(255,61,90,.25); border-radius: 10px; padding: 11px 14px; font-size: 13px; text-align: center; margin-bottom: 14px; display: none; }
    .btn-gold  { width: 100%; padding: 14px; background: var(--gold); color: #000; border: none; border-radius: 11px; font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: opacity .2s; }
    .btn-gold:disabled { opacity: .45; cursor: not-allowed; }
    .btn-gold:active   { opacity: .8; }

    /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
    #bottomNav { flex-shrink: 0; display: flex; background: var(--surface); border-top: 1px solid var(--border); padding: 6px 0 max(10px, env(safe-area-inset-bottom)); }
    .nav-btn   { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 7px 0; border: none; background: transparent; color: var(--muted); font-family: 'Outfit', sans-serif; font-size: 10px; font-weight: 600; cursor: pointer; transition: color .2s; }
    .nav-btn.on { color: var(--gold); }
    .nav-btn svg { width: 21px; height: 21px; }

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; position: sticky; top: 0; background: var(--bg); border-bottom: 1px solid var(--border); z-index: 10; }
    .topbar-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
    .back-btn { background: none; border: none; color: var(--text); font-size: 22px; cursor: pointer; padding: 0 8px 0 0; line-height: 1; }
    .bal-chip { background: rgba(34,192,99,.12); color: var(--gold); border: 1px solid rgba(34,192,99,.2); border-radius: 20px; padding: 5px 12px; font-size: 12px; font-weight: 700; }

    /* ‚îÄ‚îÄ SHARED ‚îÄ‚îÄ */
    .section-head { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; padding: 18px 20px 10px; }
    .notice { margin: 0 20px 20px; background: rgba(34,192,99,.07); border: 1px solid rgba(34,192,99,.2); border-radius: 12px; padding: 14px 16px; display: flex; gap: 12px; }
    .notice-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
    .notice-text { font-size: 13px; color: var(--muted); line-height: 1.6; }
    .notice-text strong { color: var(--gold); font-weight: 700; }
    .spinner { width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin .7s linear infinite; margin: 44px auto; display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty { text-align: center; padding: 52px 20px; color: var(--muted); }
    .empty .ei { font-size: 36px; margin-bottom: 14px; }
    .empty p { font-size: 14px; line-height: 1.6; }

    /* ‚îÄ‚îÄ MARKETS VIEW ‚îÄ‚îÄ */
    .balance-hero { margin: 16px 20px; background: linear-gradient(135deg, #0f1220 0%, var(--card) 100%); border: 1px solid var(--border); border-radius: var(--r); padding: 20px; position: relative; overflow: hidden; }
    .balance-hero::after { content: ''; position: absolute; top: -40px; right: -40px; width: 130px; height: 130px; background: radial-gradient(circle, rgba(34,192,99,.12) 0%, transparent 70%); border-radius: 50%; pointer-events: none; }
    .bh-label  { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .bh-amount { font-family: 'Syne', sans-serif; font-size: 46px; font-weight: 800; color: var(--gold); line-height: 1.1; margin: 4px 0; }
    .bh-sub    { font-size: 12px; color: var(--muted); }
    .bh-btns   { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 18px; }
    .bh-btn    { padding: 11px; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; }
    .bh-btn:active { opacity: .8; }
    .bh-dep { background: var(--gold); color: #000; }
    .bh-wd  { background: var(--card); color: var(--text); border: 1px solid var(--border); }

    /* ‚îÄ‚îÄ MARKET CARD ‚îÄ‚îÄ */
    .mkt-list { padding: 0 20px; display: flex; flex-direction: column; gap: 14px; }
    .mkt-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; }
    .mkt-top  { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 16px; }
    .mkt-q    { font-size: 15px; font-weight: 600; line-height: 1.45; flex: 1; }
    .status-chip { display: inline-block; padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; flex-shrink: 0; }
    .sc-open    { background: rgba(0,229,122,.1);   color: var(--green); }
    .sc-closed  { background: rgba(255,61,90,.1);   color: var(--red); }
    .sc-settled { background: rgba(72,80,112,.15);  color: var(--muted); }
    .odds-row  { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
    .odds-box  { border-radius: 10px; padding: 14px; text-align: center; }
    .ob-yes    { background: rgba(0,229,122,.06); border: 1px solid rgba(0,229,122,.15); }
    .ob-no     { background: rgba(255,61,90,.06);  border: 1px solid rgba(255,61,90,.15); }
    .ob-label  { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .7px; margin-bottom: 6px; }
    .ob-yes .ob-label { color: var(--green); }
    .ob-no  .ob-label { color: var(--red); }
    .ob-odds   { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; line-height: 1; }
    .ob-yes .ob-odds { color: var(--green); }
    .ob-no  .ob-odds { color: var(--red); }
    .ob-sub    { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .prob-bar  { height: 4px; background: var(--border); border-radius: 2px; margin-bottom: 14px; overflow: hidden; }
    .prob-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--green), var(--red)); transition: width .5s ease; }
    .mkt-btns  { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn-yes, .btn-no { padding: 12px; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: opacity .15s; }
    .btn-yes { background: rgba(0,229,122,.1); color: var(--green); border: 1px solid rgba(0,229,122,.2); }
    .btn-no  { background: rgba(255,61,90,.1); color: var(--red);   border: 1px solid rgba(255,61,90,.2); }
    .btn-yes:active, .btn-no:active { opacity: .7; }
    .mkt-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    .mkt-timer  { font-size: 11px; color: var(--muted); }

    /* ‚îÄ‚îÄ TRADE MODAL ‚îÄ‚îÄ */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.75); z-index: 300; align-items: flex-end; }
    .overlay.open { display: flex; }
    .sheet { width: 100%; max-width: 480px; margin: 0 auto; background: var(--card); border: 1px solid var(--border); border-radius: 22px 22px 0 0; padding: 0 20px 40px; animation: slideUp .22s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } }
    .sheet-handle  { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 14px auto 22px; }
    .sheet-title   { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 6px; }
    .sheet-q       { font-size: 13px; color: var(--muted); line-height: 1.5; margin-bottom: 20px; }
    .choice-row    { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .choice-btn    { padding: 15px; border-radius: 12px; background: var(--surface); border: 2px solid transparent; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all .15s; }
    .choice-btn.yes { color: var(--green); }
    .choice-btn.no  { color: var(--red); }
    .choice-btn.yes.sel { border-color: var(--green); background: rgba(0,229,122,.08); }
    .choice-btn.no.sel  { border-color: var(--red);   background: rgba(255,61,90,.08); }
    .stake-lbl { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stake-in  { width: 100%; background: var(--surface); border: 1.5px solid var(--border); border-radius: 11px; padding: 14px 16px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 18px; font-weight: 700; outline: none; transition: border-color .2s; margin-bottom: 10px; }
    .stake-in:focus { border-color: var(--gold); }
    .min-bet-hint { font-size: 11px; color: var(--muted); margin-bottom: 10px; }
    .quick-row { display: flex; gap: 8px; margin-bottom: 18px; }
    .q-btn { flex: 1; padding: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; }
    .q-btn:active { background: rgba(34,192,99,.12); color: var(--gold); }
    .payout-preview { background: var(--surface); border-radius: 12px; padding: 15px 16px; margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center; }
    .pp-left .pp-label { font-size: 11px; color: var(--muted); font-weight: 600; margin-bottom: 3px; }
    .pp-left .pp-odds  { font-size: 12px; color: var(--muted); }
    .pp-amount { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; color: var(--green); }
    .cancel-btn { width: 100%; margin-top: 10px; padding: 12px; background: none; border: none; color: var(--muted); font-family: 'Outfit', sans-serif; font-size: 14px; cursor: pointer; }

    /* ‚îÄ‚îÄ PORTFOLIO ‚îÄ‚îÄ */
    .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 16px 20px 0; }
    .stat-box  { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .stat-val  { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--gold); }
    .stat-lbl  { font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .6px; margin-top: 4px; }
    .trade-list { padding: 0 20px; display: flex; flex-direction: column; gap: 10px; }
    .trade-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 15px 16px; }
    .tc-q      { font-size: 13px; font-weight: 600; line-height: 1.4; margin-bottom: 10px; }
    .tc-row    { display: flex; justify-content: space-between; align-items: center; }
    .tc-left   { display: flex; gap: 8px; align-items: center; }
    .tc-badge  { font-size: 11px; font-weight: 700; padding: 3px 9px; border-radius: 20px; text-transform: uppercase; }
    .tcb-yes { background: rgba(0,229,122,.1); color: var(--green); }
    .tcb-no  { background: rgba(255,61,90,.1); color: var(--red); }
    .tc-stake  { font-size: 12px; color: var(--muted); }
    .tc-payout { font-size: 14px; font-weight: 700; }
    .tp-won    { color: var(--green); }
    .tp-lost   { color: var(--red); }
    .tp-active { color: var(--gold); }

    /* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
    .profile-card { margin: 16px 20px; background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 22px; text-align: center; }
    .avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--gold) 0%, #16803f 100%); display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: #000; margin: 0 auto 14px; }
    .prof-name  { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    /* NEW: @username shown in gold below name */
    .prof-username { font-size: 13px; color: var(--gold); font-weight: 600; margin-bottom: 4px; }
    .prof-email { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
    .tier-badge { display: inline-block; padding: 5px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .tb-free  { background: rgba(72,80,112,.2);  color: var(--muted); }
    .tb-basic { background: rgba(77,143,255,.12); color: var(--blue); }
    .tb-pro   { background: rgba(34,192,99,.12); color: var(--gold); }
    .tb-elite { background: rgba(0,229,122,.12);  color: var(--green); }
    .menu-list { padding: 0 20px; display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
    .menu-row  { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 15px 16px; display: flex; align-items: center; gap: 14px; cursor: pointer; transition: border-color .15s; }
    .menu-row:active { border-color: rgba(34,192,99,.4); }
    .menu-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .mi-gold   { background: rgba(34,192,99,.12); color: var(--gold); }
    .mi-green  { background: rgba(0,229,122,.1);   color: var(--green); }
    .mi-blue   { background: rgba(77,143,255,.1);  color: var(--blue); }
    .mi-red    { background: rgba(255,61,90,.1);   color: var(--red); }
    .mi-purple { background: rgba(168,85,247,.12); color: #a855f7; }
    .menu-info { flex: 1; }
    .mi-title { font-size: 14px; font-weight: 600; }
    .mi-sub   { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .mi-arrow { color: var(--muted); font-size: 20px; line-height: 1; }

    /* ‚îÄ‚îÄ MEMBERSHIP ‚îÄ‚îÄ */
    .mem-intro { padding: 16px 20px 0; font-size: 13px; color: var(--muted); line-height: 1.65; }
    .tier-list  { padding: 0 20px; display: flex; flex-direction: column; gap: 14px; }
    .tier-card  { border: 1px solid var(--border); border-radius: var(--r); padding: 22px; position: relative; overflow: hidden; }
    .tc-pro { border-color: rgba(34,192,99,.35); }
    .hot-tag { position: absolute; top: 14px; right: 14px; background: var(--gold); color: #000; font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; padding: 3px 9px; border-radius: 4px; }
    .tier-glow { position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; border-radius: 50%; pointer-events: none; }
    .t-basic .tier-glow { background: radial-gradient(circle, rgba(77,143,255,.1) 0%, transparent 70%); }
    .t-pro   .tier-glow { background: radial-gradient(circle, rgba(34,192,99,.12) 0%, transparent 70%); }
    .t-elite .tier-glow { background: radial-gradient(circle, rgba(0,229,122,.1) 0%, transparent 70%); }
    .tier-name  { font-family: 'Syne', sans-serif; font-size: 30px; font-weight: 800; letter-spacing: 1px; margin-bottom: 4px; }
    .t-basic .tier-name { color: var(--blue); }
    .t-pro   .tier-name { color: var(--gold); }
    .t-elite .tier-name { color: var(--green); }
    .tier-price { font-size: 13px; color: var(--muted); margin-bottom: 18px; }
    .perks      { display: flex; flex-direction: column; gap: 9px; margin-bottom: 20px; }
    .perk       { display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .perk-dot   { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
    .t-basic .perk-dot { background: var(--blue); }
    .t-pro   .perk-dot { background: var(--gold); }
    .t-elite .perk-dot { background: var(--green); }
    .tier-btn   { width: 100%; padding: 13px; border: none; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
    .tier-btn:active { opacity: .8; }
    .tbt-basic { background: rgba(77,143,255,.15); color: var(--blue); border: 1px solid rgba(77,143,255,.3); }
    .tbt-pro   { background: var(--gold); color: #000; }
    .tbt-elite { background: rgba(0,229,122,.12); color: var(--green); border: 1px solid rgba(0,229,122,.25); }

    /* ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ */
    .form-wrap { padding: 0 20px; }
    .ff        { margin-bottom: 16px; }
    .ff label  { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .ff textarea { width: 100%; background: var(--card); border: 1.5px solid var(--border); border-radius: 11px; padding: 14px 16px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 15px; resize: none; outline: none; line-height: 1.5; transition: border-color .2s; }
    .ff textarea:focus { border-color: var(--gold); }
    .char-c  { font-size: 11px; color: var(--muted); text-align: right; margin-top: 5px; }
    .sub-list { padding: 0 20px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .sub-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; }
    .sub-q    { font-size: 13px; font-weight: 600; line-height: 1.4; margin-bottom: 8px; }
    .sub-foot { display: flex; justify-content: space-between; align-items: center; }
    .ss-pending  { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--gold); }
    .ss-approved { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--green); }
    .ss-rejected { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--red); }
    .sub-pts  { font-size: 12px; color: var(--muted); }

    /* ‚îÄ‚îÄ WITHDRAW ‚îÄ‚îÄ */
    .wd-wrap    { padding: 0 20px; }
    .wd-card    { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 22px; margin-bottom: 20px; text-align: center; }
    .wd-label   { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .wd-pts     { font-family: 'Syne', sans-serif; font-size: 44px; font-weight: 800; color: var(--gold); line-height: 1; }
    .wd-eur     { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .wf-input   { width: 100%; background: var(--card); border: 1.5px solid var(--border); border-radius: 11px; padding: 14px 16px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 16px; font-weight: 600; outline: none; transition: border-color .2s; margin-bottom: 6px; }
    .wf-input:focus { border-color: var(--gold); }
    .wf-hint    { font-size: 12px; color: var(--muted); margin-bottom: 16px; }

    /* ‚îÄ‚îÄ REFERRALS PAGE ‚îÄ‚îÄ */
    /* Big gold code box at the top */
    .ref-code-box { margin: 16px 20px; background: var(--card); border: 1px solid rgba(34,192,99,.3); border-radius: 14px; padding: 24px; text-align: center; }
    .ref-code-lbl { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .ref-code-val { font-family: 'Syne', sans-serif; font-size: 42px; font-weight: 800; color: var(--gold); letter-spacing: 6px; margin-bottom: 18px; }
    .ref-share-btn { background: var(--gold); color: #000; border: none; border-radius: 10px; padding: 13px 32px; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; }
    .ref-share-btn:active { opacity: .8; }
    /* 3 stats: invited / active / earned */
    .ref-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 0 20px; margin-bottom: 6px; }
    .ref-stat  { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .ref-stat-val { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--gold); }
    .ref-stat-lbl { font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; margin-top: 4px; }
    /* Badge progress section */
    .badge-wrap { margin: 0 20px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; }
    .badge-row  { margin-bottom: 16px; }
    .badge-row:last-child { margin-bottom: 0; }
    .badge-top  { display: flex; justify-content: space-between; align-items: center; margin-bottom: 7px; }
    .badge-name { font-size: 13px; font-weight: 700; }
    .badge-req  { font-size: 11px; color: var(--muted); }
    .badge-bar  { height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .badge-fill { height: 100%; border-radius: 3px; transition: width .5s ease; }
    /* How it works box */
    .ref-how { margin: 0 20px 24px; background: rgba(34,192,99,.06); border: 1px solid rgba(34,192,99,.18); border-radius: 12px; padding: 16px; }
    .ref-how-title { font-size: 12px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .ref-how-step  { font-size: 13px; color: var(--muted); line-height: 2; }
    .ref-how-step strong { color: var(--text); }

    /* ‚îÄ‚îÄ HISTORY VIEW (deposits + withdrawals) ‚îÄ‚îÄ */
    .hist-tabs   { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; padding: 16px 20px 0; }
    .hist-tab    { padding: 10px; border: 1.5px solid var(--border); border-radius: 10px; background: transparent; color: var(--muted); font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
    .hist-tab.on { background: rgba(34,192,99,.1); border-color: rgba(34,192,99,.35); color: var(--gold); }
    .hist-list   { padding: 14px 20px; display: flex; flex-direction: column; gap: 10px; }
    .hist-card   { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 15px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .hist-left   { flex: 1; min-width: 0; }
    .hist-type   { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
    .hist-date   { font-size: 11px; color: var(--muted); }
    .hist-iban   { font-size: 11px; color: var(--muted); margin-top: 2px; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
    .hist-right  { text-align: right; flex-shrink: 0; }
    .hist-amt    { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; }
    .hist-eur    { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .hist-status { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-top: 4px; }
    .hs-pending    { color: var(--gold); }
    .hs-completed  { color: var(--green); }
    .hs-processing { color: var(--blue); }
    .hs-rejected   { color: var(--red); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast { position: fixed; bottom: 92px; left: 50%; transform: translateX(-50%) translateY(12px); background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 11px 20px; font-size: 13px; font-weight: 600; white-space: nowrap; z-index: 999; opacity: 0; transition: all .25s; pointer-events: none; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.ok  { border-color: rgba(0,229,122,.4);  color: var(--green); }
    #toast.bad { border-color: rgba(255,61,90,.4);  color: var(--red); }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH SCREEN ‚Äî shown before login/signup
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authWrap">
  <div class="auth-box">
    <div class="auth-logo">CASSINO TRADE</div>
    <div class="auth-sub">Predict markets ¬∑ Trade points ¬∑ Win big</div>

    <!-- Tab switcher: Sign Up / Login -->
    <div class="tab-row">
      <button class="tab-btn on" id="tabSU" onclick="authTab('su')">Sign Up</button>
      <button class="tab-btn"    id="tabLI" onclick="authTab('li')">Login</button>
    </div>

    <!-- Error message box (hidden by default) -->
    <div class="err-box" id="authErr"></div>

    <!-- ‚îÄ‚îÄ SIGN UP FORM ‚îÄ‚îÄ -->
    <div id="formSU">

      <!-- USERNAME ‚Äî new field! User picks their own username.
           We use this to generate their referral code (e.g. suryansh ‚Üí SURY847) -->
      <div class="f">
        <label>Username</label>
        <input
          type="text"
          id="suUsername"
          placeholder="e.g. suryansh"
          autocomplete="off"
          oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'')"
        />
        <!-- Hint explaining the rules -->
        <div class="f-hint">Only letters, numbers, underscores ¬∑ min 3 chars</div>
      </div>

      <div class="f">
        <label>Email</label>
        <input type="email" id="suEmail" placeholder="you@email.com"/>
      </div>

      <div class="f">
        <label>Password</label>
        <input type="password" id="suPass" placeholder="Min 6 characters"/>
      </div>

      <div class="f">
        <label>Confirm Password</label>
        <input type="password" id="suConf" placeholder="Repeat password"/>
      </div>

      <!-- REFERRAL CODE ‚Äî optional, enter a friend's code here.
           Both you and your friend get 100 pts when you place your first trade -->
      <div class="f">
        <label>Referral Code <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
        <input
          type="text"
          id="suRef"
          placeholder="e.g. SURY847"
          autocomplete="off"
          style="text-transform:uppercase"
          oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
        />
        <div class="f-hint">Have a friend's code? Enter it for a free 100 pts bonus!</div>
      </div>

      <button class="btn-gold" id="suBtn" onclick="doSignup()">Create Account</button>
    </div>

    <!-- ‚îÄ‚îÄ LOGIN FORM ‚îÄ‚îÄ -->
    <div id="formLI" style="display:none">
      <div class="f">
        <label>Email</label>
        <input type="email" id="liEmail" placeholder="you@email.com"/>
      </div>
      <div class="f">
        <label>Password</label>
        <input type="password" id="liPass" placeholder="Your password"/>
      </div>
      <button class="btn-gold" id="liBtn" onclick="doLogin()">Login</button>
    </div>

    <div style="text-align:center;margin-top:14px">
      <button onclick="doForgotPassword()" style="background:none;border:none;color:var(--muted);font-family:Outfit,sans-serif;font-size:13px;cursor:pointer;text-decoration:underline">Forgot password?</button>
    </div>

    <!-- ‚îÄ‚îÄ FORGOT PASSWORD FORM ‚îÄ‚îÄ -->
    <div id="formFP" style="display:none">
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-size:16px;font-weight:700;margin-bottom:6px">Reset Password</div>
        <div style="font-size:13px;color:var(--muted)">We'll send a reset link to your email</div>
      </div>
      <div class="f"><label>Email</label><input type="email" id="fpEmail" placeholder="you@email.com"/></div>
      <div class="err-box" id="fpErr"></div>
      <div class="err-box" style="background:rgba(0,229,122,.1);color:var(--green);border-color:rgba(0,229,122,.25);display:none" id="fpOk"></div>
      <button class="btn-gold" id="fpBtn" onclick="sendReset()">Send Reset Link</button>
      <div style="text-align:center;margin-top:14px">
        <button onclick="authTab('li')" style="background:none;border:none;color:var(--muted);font-family:Outfit,sans-serif;font-size:13px;cursor:pointer;text-decoration:underline">Back to login</button>
      </div>
    </div>

    <!-- Spacer so content doesn't get cut off on small phones -->
    <div style="height:24px"></div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP ‚Äî shown after login
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appShell">

  <!-- ‚îÄ‚îÄ MARKETS VIEW ‚îÄ‚îÄ -->
  <div class="view active" id="vMarkets">
    <div class="topbar">
      <div class="topbar-title">Markets</div>
      <div class="bal-chip">‚ö° <span id="topBal">0</span> pts</div>
    </div>
    <div class="balance-hero">
      <div class="bh-label">Balance</div>
      <div class="bh-amount" id="heroBal">0</div>
      <div class="bh-sub">points ¬∑ ‚Ç¨1 = 10 pts</div>
      <div class="bh-btns">
        <button class="bh-btn bh-dep" onclick="openDeposit()">Ôºã Deposit</button>
        <button class="bh-btn bh-wd"  onclick="goTo('withdraw')">Withdraw</button>
      </div>
    </div>
    <div class="section-head">Live Markets</div>
    <div class="mkt-list" id="mktList"><div class="spinner"></div></div>
  </div>

  <!-- ‚îÄ‚îÄ PORTFOLIO VIEW ‚îÄ‚îÄ -->
  <div class="view" id="vPortfolio">
    <div class="topbar"><div class="topbar-title">My Trades</div></div>
    <div class="stats-row">
      <div class="stat-box"><div class="stat-val" id="stTotal">‚Äî</div><div class="stat-lbl">Total</div></div>
      <div class="stat-box"><div class="stat-val" id="stWon">‚Äî</div><div class="stat-lbl">Won</div></div>
      <div class="stat-box"><div class="stat-val" id="stPts">‚Äî</div><div class="stat-lbl">Pts Won</div></div>
    </div>
    <div class="section-head">Trade History</div>
    <div class="trade-list" id="tradeList"><div class="spinner"></div></div>
  </div>

  <!-- ‚îÄ‚îÄ SUBMIT VIEW ‚îÄ‚îÄ -->
  <div class="view" id="vSubmit">
    <div class="topbar"><div class="topbar-title">Submit Question</div></div>
    <div class="notice">
      <div class="notice-icon">üí°</div>
      <div class="notice-text">Propose a market for the community to trade on. Costs <strong>100 pts</strong> ‚Äî refunded if rejected. We review within 24 hours.</div>
    </div>
    <div class="section-head">Your Question</div>
    <div class="form-wrap">
      <div class="ff">
        <label>Question <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0">(min 10 chars)</span></label>
        <textarea id="sqQ" rows="4" maxlength="200" placeholder="e.g. Will Bitcoin hit $100k before June 2025?" oninput="document.getElementById('sqC').innerText=this.value.length+'/200'"></textarea>
        <div class="char-c" id="sqC">0/200</div>
      </div>
      <div class="ff">
        <label>Context <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
        <textarea id="sqCtx" rows="2" maxlength="300" placeholder="Any background info..."></textarea>
      </div>
      <div class="err-box" id="sqErr"></div>
      <button class="btn-gold" id="sqBtn" onclick="doSubmit()">Submit ¬∑ 100 pts</button>
    </div>
    <div class="section-head" style="margin-top:24px">My Submissions</div>
    <div class="sub-list" id="subList"><div class="spinner"></div></div>
  </div>

  <!-- ‚îÄ‚îÄ PROFILE VIEW ‚îÄ‚îÄ -->
  <div class="view" id="vProfile">
    <div class="topbar"><div class="topbar-title">Profile</div></div>
    <div class="profile-card">
      <!-- Avatar: first letter of name in a gold circle -->
      <div class="avatar" id="profAv">?</div>
      <div class="prof-name" id="profName">‚Äî</div>
      <!-- NEW: shows @username in gold -->
      <div class="prof-username" id="profUsername"></div>
      <div class="prof-email" id="profEmail">‚Äî</div>
      <!-- NEW: shows referral badge if earned (hidden until earned) -->
      <div id="profBadgeWrap" style="display:none;margin-top:8px">
        <span id="profBadge" style="display:inline-block;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(168,85,247,.15);color:#a855f7;letter-spacing:1px"></span>
      </div>
      <div style="margin-top:10px">
        <span class="tier-badge tb-free" id="profTier">Free</span>
      </div>
    </div>
    <div class="menu-list">
      <!-- NEW: Referrals menu item -->
      <div class="menu-row" onclick="goTo('referrals')">
        <div class="menu-icon mi-purple">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div class="menu-info">
          <div class="mi-title">Referrals</div>
          <div class="mi-sub">Invite friends ¬∑ earn 100 pts each</div>
        </div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
      <div class="menu-row" onclick="goTo('membership')">
        <div class="menu-icon mi-gold"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
        <div class="menu-info"><div class="mi-title">Membership</div><div class="mi-sub">Upgrade for better limits &amp; perks</div></div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
      <div class="menu-row" onclick="goTo('portfolio')">
        <div class="menu-icon mi-blue"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
        <div class="menu-info"><div class="mi-title">Trade History</div><div class="mi-sub">See all your past bets</div></div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
      <div class="menu-row" onclick="goTo('history')">
        <div class="menu-icon mi-blue" style="background:rgba(77,143,255,.1);color:var(--blue)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </div>
        <div class="menu-info">
          <div class="mi-title">Deposit &amp; Withdrawal History</div>
          <div class="mi-sub">All your past transactions</div>
        </div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
      <div class="menu-row" onclick="openDeposit()">
        <div class="menu-icon mi-green"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg></div>
        <div class="menu-info"><div class="mi-title">Deposit</div><div class="mi-sub">Add points ¬∑ min ‚Ç¨10 ¬∑ ‚Ç¨1 = 10 pts</div></div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
      <div class="menu-row" onclick="goTo('withdraw')">
        <div class="menu-icon mi-red"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></div>
        <div class="menu-info"><div class="mi-title">Withdraw</div><div class="mi-sub">Cash out ¬∑ min ‚Ç¨20</div></div>
        <div class="mi-arrow">‚Ä∫</div>
      </div>
    </div>
    <div style="text-align:center;color:var(--muted);font-size:11px;padding:0 0 20px">Telegram ID: <span id="profTgId">‚Äî</span></div>
  </div>

  <!-- ‚îÄ‚îÄ REFERRALS VIEW ‚Äî NEW PAGE ‚îÄ‚îÄ -->
  <div class="view" id="vReferrals">
    <div class="topbar">
      <button class="back-btn" onclick="goBack()">‚Äπ</button>
      <div class="topbar-title">Referrals</div>
      <div style="width:30px"></div>
    </div>

    <!-- Big referral code display + share button -->
    <div class="ref-code-box">
      <div class="ref-code-lbl">Your Referral Code</div>
      <!-- This gets filled in by loadReferrals() from the database -->
      <div class="ref-code-val" id="refCode">‚Äî</div>
      <button class="ref-share-btn" onclick="shareReferral()">üì§ Share with Friends</button>
    </div>

    <!-- Stats row: how many invited, how many completed, points earned -->
    <div class="ref-stats">
      <div class="ref-stat">
        <div class="ref-stat-val" id="refTotal">0</div>
        <div class="ref-stat-lbl">Invited</div>
      </div>
      <div class="ref-stat">
        <div class="ref-stat-val" id="refActive" style="color:var(--green)">0</div>
        <div class="ref-stat-lbl">Active</div>
      </div>
      <div class="ref-stat">
        <div class="ref-stat-val" id="refEarned">0</div>
        <div class="ref-stat-lbl">Pts Earned</div>
      </div>
    </div>

    <!-- How it works box -->
    <div class="ref-how">
      <div class="ref-how-title">How It Works</div>
      <div class="ref-how-step">
        <strong>1.</strong> Share your code with friends<br>
        <strong>2.</strong> Friend signs up using your code<br>
        <strong>3.</strong> Friend places their first trade<br>
        <strong>4. You BOTH get +100 pts instantly! üéØ</strong>
      </div>
    </div>

    <!-- Badge progress ‚Äî like video game achievements -->
    <div class="section-head">Badge Progress</div>
    <div class="badge-wrap" id="badgeWrap">
      <div class="spinner"></div>
    </div>

    <!-- Per-person list ‚Äî every friend who used the code with their reward status -->
    <div class="section-head">People Who Used Your Code</div>
    <div id="refPeopleList" style="padding:0 20px 24px;display:flex;flex-direction:column;gap:10px">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ MEMBERSHIP VIEW ‚îÄ‚îÄ -->
  <div class="view" id="vMembership">
    <div class="topbar">
      <button class="back-btn" onclick="goBack()">‚Äπ</button>
      <div class="topbar-title">Membership</div>
      <div style="width:30px"></div>
    </div>
    <div class="mem-intro">Unlock higher limits, lower fees, and early market access with a monthly membership.</div>
    <div class="section-head">Choose a Plan</div>
    <div class="tier-list">
      <div class="tier-card t-basic" onclick="doSubscribe('basic')">
        <div class="tier-glow"></div>
        <div class="tier-name">Basic</div>
        <div class="tier-price">‚Ç¨8.99 / month</div>
        <div class="perks">
          <div class="perk"><div class="perk-dot"></div>Max stake: 50,000 pts per trade</div>
          <div class="perk"><div class="perk-dot"></div>4% platform fee (free = 5%)</div>
          <div class="perk"><div class="perk-dot"></div>100 pts welcome bonus</div>
        </div>
        <button class="tier-btn tbt-basic">Get Basic ¬∑ ‚Ç¨8.99/mo</button>
      </div>
      <div class="tier-card t-pro tc-pro" onclick="doSubscribe('pro')">
        <div class="tier-glow"></div>
        <div class="hot-tag">Popular</div>
        <div class="tier-name">Pro</div>
        <div class="tier-price">‚Ç¨26.99 / month</div>
        <div class="perks">
          <div class="perk"><div class="perk-dot"></div>Max stake: 200,000 pts per trade</div>
          <div class="perk"><div class="perk-dot"></div>3% platform fee</div>
          <div class="perk"><div class="perk-dot"></div>2 hrs early market access</div>
          <div class="perk"><div class="perk-dot"></div>500 pts welcome bonus</div>
        </div>
        <button class="tier-btn tbt-pro">Get Pro ¬∑ ‚Ç¨26.99/mo</button>
      </div>
      <div class="tier-card t-elite" onclick="doSubscribe('elite')">
        <div class="tier-glow"></div>
        <div class="tier-name">Elite</div>
        <div class="tier-price">‚Ç¨53.99 / month</div>
        <div class="perks">
          <div class="perk"><div class="perk-dot"></div>Unlimited stake per trade</div>
          <div class="perk"><div class="perk-dot"></div>2% platform fee (lowest)</div>
          <div class="perk"><div class="perk-dot"></div>6 hrs early market access</div>
          <div class="perk"><div class="perk-dot"></div>2,000 pts welcome bonus</div>
        </div>
        <button class="tier-btn tbt-elite">Get Elite ¬∑ ‚Ç¨53.99/mo</button>
      </div>
    </div>
    <div style="height:24px"></div>
  </div>

  <!-- ‚îÄ‚îÄ WITHDRAW VIEW ‚îÄ‚îÄ -->
  <div class="view" id="vWithdraw">
    <div class="topbar">
      <button class="back-btn" onclick="goBack()">‚Äπ</button>
      <div class="topbar-title">Withdraw</div>
      <div style="width:30px"></div>
    </div>
    <div class="wd-wrap">
      <div class="wd-card">
        <div class="wd-label">Available Balance</div>
        <div class="wd-pts" id="wdBal">0</div>
        <div class="wd-eur" id="wdBalEur">‚âà ‚Ç¨0.00</div>
      </div>
      <div class="notice" style="margin:0 0 20px">
        <div class="notice-icon">‚ÑπÔ∏è</div>
        <div class="notice-text">Minimum <strong>200 pts (‚Ç¨20)</strong>. Processed via bank transfer in 2‚Äì5 business days.</div>
      </div>
      <div class="ff" style="margin-bottom:8px">
        <label>Amount in Points</label>
        <input type="number" class="wf-input" id="wdAmt" placeholder="e.g. 200" min="200" oninput="wdCalc()"/>
        <div class="wf-hint" id="wdHint">‚âà ‚Ç¨0.00</div>
      </div>
      <div class="ff">
        <label>Bank IBAN</label>
        <input type="text" class="wf-input" id="wdIban" placeholder="IT60 X054 2811 1010 0000 0123 456"/>
      </div>
      <div class="err-box" id="wdErr"></div>
      <button class="btn-gold" onclick="doWithdraw()">Request Withdrawal</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ HISTORY VIEW (deposits + withdrawals in one place) ‚îÄ‚îÄ -->
  <div class="view" id="vHistory">
    <div class="topbar">
      <button class="back-btn" onclick="goBack()">‚Äπ</button>
      <div class="topbar-title">History</div>
      <div style="width:30px"></div>
    </div>

    <!-- Two tabs: Deposits / Withdrawals -->
    <div class="hist-tabs">
      <button class="hist-tab on" id="htDep" onclick="histTab('dep')">‚¨áÔ∏è Deposits</button>
      <button class="hist-tab"    id="htWd"  onclick="histTab('wd')">‚¨ÜÔ∏è Withdrawals</button>
    </div>

    <!-- List gets rendered here by JS -->
    <div class="hist-list" id="histList">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ BOTTOM NAV BAR ‚îÄ‚îÄ -->
  <nav id="bottomNav">
    <button class="nav-btn on" id="nb-markets" onclick="goTo('markets')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Markets
    </button>
    <button class="nav-btn" id="nb-portfolio" onclick="goTo('portfolio')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Trades
    </button>
    <button class="nav-btn" id="nb-submit" onclick="goTo('submit')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      Submit
    </button>
    <button class="nav-btn" id="nb-profile" onclick="goTo('profile')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Profile
    </button>
  </nav>
</div>

<!-- ‚îÄ‚îÄ TRADE MODAL (slides up from bottom) ‚îÄ‚îÄ -->
<div class="overlay" id="tradeOverlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Place Trade</div>
    <div class="sheet-q" id="sheetQ"></div>
    <div class="choice-row">
      <button class="choice-btn yes" id="chYes" onclick="pick('YES')">‚úÖ YES</button>
      <button class="choice-btn no"  id="chNo"  onclick="pick('NO')">‚ùå NO</button>
    </div>
    <div class="stake-lbl">Stake (points)</div>
    <input class="stake-in" id="stakeIn" type="number" placeholder="Min 100 pts" oninput="calcPayout()" min="100"/>
    <div class="min-bet-hint">Minimum bet: 100 pts</div>
    <div class="quick-row">
      <button class="q-btn" onclick="qs(100)">100</button>
      <button class="q-btn" onclick="qs(500)">500</button>
      <button class="q-btn" onclick="qs(1000)">1K</button>
      <button class="q-btn" onclick="qs(5000)">5K</button>
      <button class="q-btn" onclick="qs(10000)">10K</button>
    </div>
    <div class="payout-preview">
      <div class="pp-left">
        <div class="pp-label">Potential payout</div>
        <div class="pp-odds" id="ppOdds">Pick YES or NO first</div>
      </div>
      <div class="pp-amount" id="ppAmt">‚Äî</div>
    </div>
    <button class="btn-gold" id="tradeBtn" onclick="placeTrade()">Confirm Trade</button>
    <button class="cancel-btn" onclick="closeModal()">Cancel</button>
  </div>
</div>

<div id="toast"></div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT ‚Äî all logic lives here
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPA_URL    = "https://liketekvzrazheolmfnj.supabase.co";
const SUPA_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxpa2V0ZWt2enJhemhlb2xtZm5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNDg0MzYsImV4cCI6MjA4NjgyNDQzNn0.8Zo-NJ0QmaH95zt3Nh4yV20M0HM5OOH9V0cDs1xYpPE";
const PTS_PER_EUR  = 10;    // ‚Ç¨1 = 10 pts
const MIN_STAKE    = 100;   // minimum bet
const MIN_DEPOSIT  = 10;    // minimum deposit in euros
const MIN_WITHDRAW = 200;   // minimum withdrawal in points (= ‚Ç¨20)
const VIRTUAL_POOL = 1000;  // used for odds smoothing
const START_ODDS   = 1.80;  // starting odds when market has no bets

const db = createClient(SUPA_URL, SUPA_KEY);
window._db = db; // expose to withdrawal code

// ‚îÄ‚îÄ APP STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tgId       = null;  // telegram user ID
let tgInitData = null;  // telegram auth data (proves who the user is)
let balance    = 0;     // current points balance
let markets    = [];    // loaded markets array
let activeMkt  = null;  // market selected for trading
let choice     = null;  // "YES" or "NO" selected in modal
let prevView   = "markets"; // for back button

// ‚îÄ‚îÄ EXPOSE ALL FUNCTIONS SO HTML onclick CAN CALL THEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// (This is needed because we use type="module" which has its own scope)
Object.assign(window, {
  doForgotPassword, sendReset,
  authTab, doSignup, doLogin,
  goTo, goBack,
  openDeposit,
  openTradeModal, closeModal, pick, qs, calcPayout, placeTrade,
  doSubmit,
  doSubscribe,
  wdCalc, doWithdraw,
  shareReferral,
  histTab,         // NEW ‚Äî switches between deposits/withdrawals
  showToast
});

// ‚îÄ‚îÄ APP BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// This runs when the page first loads
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.setBackgroundColor("#06070b"); }
  tgInitData = tg?.initData || "";

  // Step 1: prove who the user is via Telegram
  const result = await telegramLogin();
  if (!result) return;
  tgId = String(tg?.initDataUnsafe?.user?.id || "");

  // Step 2: if they already have an email linked, go straight to app
  if (result.email_linked) {
    balance = result.balance_points || 0;
    startApp();
  } else {
    // Otherwise show the login/signup screen
    document.getElementById("authWrap").style.display = "flex";
  }
});

// Calls our telegram-login edge function to verify the user's identity
async function telegramLogin() {
  try {
    const res = await fetch(`${SUPA_URL}/functions/v1/telegram-login`, {
      method: "POST", headers: { "Content-Type": "text/plain" }, body: tgInitData
    });
    if (!res.ok) return null;
    return await res.json();
  } catch { return null; }
}

// ‚îÄ‚îÄ AUTH FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Switches between Sign Up and Login tabs
function authTab(t) {
  document.getElementById("formSU").style.display = t === "su" ? "block" : "none";
  document.getElementById("formLI").style.display = t === "li" ? "block" : "none";
  document.getElementById("formFP").style.display = "none";
  document.getElementById("tabSU").classList.toggle("on", t === "su");
  document.getElementById("tabLI").classList.toggle("on", t === "li");
  setErr("authErr", "");
}

// Shows the forgot password form
function doForgotPassword() {
  document.getElementById("formSU").style.display = "none";
  document.getElementById("formLI").style.display = "none";
  document.getElementById("formFP").style.display = "block";
  const liEmail = document.getElementById("liEmail").value.trim();
  if (liEmail) document.getElementById("fpEmail").value = liEmail;
  setErr("authErr", "");
}

// Sends a password reset email
async function sendReset() {
  const email = document.getElementById("fpEmail").value.trim();
  const errEl = document.getElementById("fpErr");
  const okEl  = document.getElementById("fpOk");
  errEl.style.display = "none";
  okEl.style.display  = "none";
  if (!email) { errEl.innerText = "Enter your email first."; errEl.style.display = "block"; return; }
  const btn = document.getElementById("fpBtn");
  btn.disabled = true; btn.innerText = "Sending...";
  try {
    await fetch(`${SUPA_URL}/auth/v1/recover`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "apikey": SUPA_KEY },
      body: JSON.stringify({ email, redirect_to: "https://opinion-miniapp.vercel.app" })
    });
    okEl.innerText = "If that email exists, a reset link has been sent. Check your inbox and spam folder.";
    okEl.style.display = "block";
  } catch { errEl.innerText = "Connection error. Try again."; errEl.style.display = "block"; }
  finally { btn.disabled = false; btn.innerText = "Send Reset Link"; }
}

// Helper: show or hide an error message box
function setErr(id, msg) {
  const el = document.getElementById(id);
  el.innerText = msg;
  el.style.display = msg ? "block" : "none";
}

// ‚îÄ‚îÄ SIGN UP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Reads all signup fields including the new username and optional referral code
async function doSignup() {
  // Read the new username field
  const username = document.getElementById("suUsername").value.trim().toLowerCase();
  const email    = document.getElementById("suEmail").value.trim();
  const pass     = document.getElementById("suPass").value;
  const conf     = document.getElementById("suConf").value;
  // Read optional referral code (friend's code)
  const refCode  = document.getElementById("suRef").value.trim().toUpperCase();

  // Validate username: min 3 chars, only letters/numbers/underscores
  if (!username || username.length < 3)
    return setErr("authErr", "Username must be at least 3 characters.");
  if (!/^[a-z0-9_]+$/.test(username))
    return setErr("authErr", "Username: only letters, numbers, underscores allowed.");

  if (!email || !pass)  return setErr("authErr", "Fill in all fields.");
  if (pass !== conf)    return setErr("authErr", "Passwords don't match.");
  if (pass.length < 6)  return setErr("authErr", "Password must be 6+ chars.");

  setErr("authErr", "");
  const btn = document.getElementById("suBtn");
  btn.disabled = true; btn.innerText = "Creating...";

  try {
    // Send to our register edge function
    // The function will:
    //   1. Check username is not taken
    //   2. Create the Supabase auth account
    //   3. Generate referral code from username (e.g. suryansh ‚Üí SURY847)
    //   4. If referral code provided, create a referral record
    const res = await fetch(`${SUPA_URL}/functions/v1/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email,
        password:      pass,
        telegram_id:   tgId,
        username:      username,        // user chose this
        full_name:     window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || "",
        referral_code: refCode || null  // friend's code, if entered
      })
    });
    const data = await res.json();
    if (!res.ok) return setErr("authErr", data.error || "Signup failed.");
    balance = 0;
    startApp();
  } catch { setErr("authErr", "Connection error. Try again."); }
  finally { btn.disabled = false; btn.innerText = "Create Account"; }
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const email = document.getElementById("liEmail").value.trim();
  const pass  = document.getElementById("liPass").value;
  if (!email || !pass) return setErr("authErr", "Fill in all fields.");
  setErr("authErr", "");
  const btn = document.getElementById("liBtn");
  btn.disabled = true; btn.innerText = "Logging in...";
  try {
    const { data: auth, error } = await db.auth.signInWithPassword({ email, password: pass });
    if (error) return setErr("authErr", "Login failed: " + (error.message || "Wrong email or password."));
    // Link this Telegram ID to the account (so next time auto-login works)
    await db.from("users").update({ telegram_id: tgId }).eq("auth_id", auth.user.id);
    await db.from("wallets").upsert({ telegram_id: tgId, balance_points: 0, balance_eur: 0 }, { onConflict: "telegram_id", ignoreDuplicates: true });
    const { data: w } = await db.from("wallets").select("balance_points").eq("telegram_id", tgId).single();
    balance = w?.balance_points || 0;
    startApp();
  } catch { setErr("authErr", "Connection error. Try again."); }
  finally { btn.disabled = false; btn.innerText = "Login"; }
}

// ‚îÄ‚îÄ START APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startApp() {
  document.getElementById("authWrap").style.display = "none";
  document.getElementById("appShell").classList.add("show");
  updateBalUI();
  loadMarkets();
  loadProfile();
  subscribeWallet(); // listen for realtime balance changes
}

// ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Updates all the places on screen that show the balance
function updateBalUI() {
  const f = balance.toLocaleString();
  document.getElementById("topBal").innerText   = f;
  document.getElementById("heroBal").innerText  = f;
  document.getElementById("wdBal").innerText    = f;
  document.getElementById("wdBalEur").innerText = `‚âà ‚Ç¨${(balance / PTS_PER_EUR).toFixed(2)}`;
}

// Listen for realtime updates from the DB ‚Äî balance changes instantly
function subscribeWallet() {
  db.channel("wallet-rt").on("postgres_changes",
    { event: "UPDATE", schema: "public", table: "wallets" },
    p => { if (p.new.telegram_id === tgId) { balance = p.new.balance_points; updateBalUI(); } }
  ).subscribe();
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Maps friendly names to HTML element IDs
const viewMap = {
  markets:    "vMarkets",
  portfolio:  "vPortfolio",
  submit:     "vSubmit",
  profile:    "vProfile",
  referrals:  "vReferrals",
  history:    "vHistory",     // NEW ‚Äî deposit + withdrawal history
  membership: "vMembership",
  withdraw:   "vWithdraw"
};

function goTo(name) {
  prevView = currentView(); // save current so back button works
  // Hide all views, show the one we want
  Object.values(viewMap).forEach(id => document.getElementById(id)?.classList.remove("active"));
  document.getElementById(viewMap[name])?.classList.add("active");
  document.getElementById(viewMap[name]).scrollTop = 0;
  // Update bottom nav highlight
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("on"));
  const nb = document.getElementById("nb-" + name);
  if (nb) nb.classList.add("on");
  // Load data for specific pages when navigating to them
  if (name === "portfolio") loadTrades();
  if (name === "submit")    loadSubmissions();
  if (name === "withdraw")  updateBalUI();
  if (name === "referrals") loadReferrals();
  if (name === "history")   loadHistory("dep"); // NEW ‚Äî load deposits by default
}

function currentView() {
  for (const [k, v] of Object.entries(viewMap))
    if (document.getElementById(v)?.classList.contains("active")) return k;
  return "markets";
}

function goBack() { goTo(prevView || "profile"); }

// ‚îÄ‚îÄ ODDS CALCULATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Calculates odds from pool amounts using a "virtual pool" anchor
// This keeps odds near 1.80 when a market is new (no bets yet)
function calcOdds(yesPool, noPool) {
  const total = yesPool + noPool;
  if (total === 0) return { yesOdds: START_ODDS, noOdds: START_ODDS };
  const rawYes = yesPool > 0 ? total / yesPool : START_ODDS * 2;
  const rawNo  = noPool  > 0 ? total / noPool  : START_ODDS * 2;
  const V = VIRTUAL_POOL;
  const anchoredYes = (yesPool * rawYes + V * START_ODDS) / (yesPool + V);
  const anchoredNo  = (noPool  * rawNo  + V * START_ODDS) / (noPool  + V);
  return {
    yesOdds: Math.max(1.01, parseFloat(anchoredYes.toFixed(2))),
    noOdds:  Math.max(1.01, parseFloat(anchoredNo.toFixed(2)))
  };
}

// ‚îÄ‚îÄ MARKETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMarkets() {
  try {
    const res = await fetch(`${SUPA_URL}/functions/v1/get-markets`, {
      headers: { "apikey": SUPA_KEY, "Authorization": `Bearer ${SUPA_KEY}` }
    });
    markets = await res.json();
    renderMarkets();
  } catch {
    document.getElementById("mktList").innerHTML =
      `<div class="empty"><div class="ei">‚ö†Ô∏è</div><p>Failed to load markets.<br>Pull to refresh.</p></div>`;
  }
}

function renderMarkets() {
  const el = document.getElementById("mktList");
  if (!markets?.length) {
    el.innerHTML = `<div class="empty"><div class="ei">üéØ</div><p>No open markets right now.<br>Check back soon!</p></div>`;
    return;
  }
  el.innerHTML = markets.map(m => {
    const yesOdds = m.yes_odds || 1.80;
    const noOdds  = m.no_odds  || 1.80;
    // Probability bar: based on implied probability (1/odds), normalized to 100%
    const impliedYes = 1 / yesOdds;
    const impliedNo  = 1 / noOdds;
    const yesPct = Math.round((impliedYes / (impliedYes + impliedNo)) * 100);
    const diff   = new Date(m.closes_at) - Date.now();
    const timer  = diff <= 0 ? "Closed"
      : diff < 3600000  ? `${Math.floor(diff/60000)}m left`
      : diff < 86400000 ? `${Math.floor(diff/3600000)}h left`
      : `${Math.floor(diff/86400000)}d left`;
    const canTrade  = m.status === "open" && diff > 0;
    const chipClass = m.status === "open" ? "sc-open" : m.status === "closed" ? "sc-closed" : "sc-settled";
    return `<div class="mkt-card">
      <div class="mkt-top">
        <div class="mkt-q">${m.question}</div>
        <span class="status-chip ${chipClass}">${m.status}</span>
      </div>
      <div class="odds-row">
        <div class="odds-box ob-yes">
          <div class="ob-label">YES</div>
          <div class="ob-odds">√ó${yesOdds}</div>
          <div class="ob-sub">if you win</div>
        </div>
        <div class="odds-box ob-no">
          <div class="ob-label">NO</div>
          <div class="ob-odds">√ó${noOdds}</div>
          <div class="ob-sub">if you win</div>
        </div>
      </div>
      <div class="prob-bar"><div class="prob-fill" style="width:${yesPct}%"></div></div>
      ${canTrade
        ? `<div class="mkt-btns">
            <button class="btn-yes" onclick="openTradeModal('${m.id}','YES')">Bet YES √ó${yesOdds}</button>
            <button class="btn-no"  onclick="openTradeModal('${m.id}','NO')">Bet NO √ó${noOdds}</button>
           </div>`
        : m.result
          ? `<div style="text-align:center;padding:10px 0">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px">Final Result</div>
               <div style="font-size:20px;font-weight:800;color:${m.result==='yes'?'var(--green)':'var(--red)'}">
                 ${m.result==='yes' ? '‚úÖ YES' : '‚ùå NO'}
               </div>
             </div>`
          : `<div style="text-align:center;font-size:12px;color:var(--muted);padding:8px 0">‚è≥ Awaiting result...</div>`}
      <div class="mkt-footer">
        <div class="mkt-timer">üïê ${timer}</div>
        <div style="font-size:11px;color:var(--muted)">min bet: 100 pts</div>
      </div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ TRADE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTradeModal(id, c) {
  activeMkt = markets.find(m => m.id === id);
  if (!activeMkt) return;
  choice = null;
  document.getElementById("sheetQ").innerText   = activeMkt.question;
  document.getElementById("stakeIn").value      = "";
  document.getElementById("ppAmt").innerText    = "‚Äî";
  document.getElementById("ppOdds").innerText   = "Pick YES or NO first";
  document.getElementById("chYes").classList.remove("sel");
  document.getElementById("chNo").classList.remove("sel");
  document.getElementById("tradeOverlay").classList.add("open");
  if (c) pick(c); // pre-select YES or NO if called with it
}

function closeModal() {
  document.getElementById("tradeOverlay").classList.remove("open");
  activeMkt = null; choice = null;
}

function pick(c) {
  choice = c;
  document.getElementById("chYes").classList.toggle("sel", c === "YES");
  document.getElementById("chNo").classList.toggle("sel",  c === "NO");
  calcPayout();
}

function qs(n) {
  document.getElementById("stakeIn").value = n;
  calcPayout();
}

function calcPayout() {
  if (!activeMkt || !choice) return;
  const stake = parseInt(document.getElementById("stakeIn").value) || 0;
  if (stake > 0 && stake < MIN_STAKE) {
    document.getElementById("ppAmt").innerText  = "‚Äî";
    document.getElementById("ppOdds").innerText = `Minimum bet is ${MIN_STAKE} pts`;
    return;
  }
  if (stake <= 0) { document.getElementById("ppAmt").innerText = "‚Äî"; return; }
  const odds   = choice === "YES" ? (activeMkt.yes_odds || START_ODDS) : (activeMkt.no_odds || START_ODDS);
  const gross  = Math.floor(stake * odds);
  const fee    = Math.floor(gross * 0.05); // 5% platform fee
  const payout = gross - fee;
  document.getElementById("ppAmt").innerText  = payout.toLocaleString() + " pts";
  document.getElementById("ppOdds").innerText = `√ó${odds} odds ¬∑ 5% fee applied`;
}

async function placeTrade() {
  if (!choice) return showToast("Select YES or NO", "bad");
  const stake = parseInt(document.getElementById("stakeIn").value);
  if (!stake || stake <= 0) return showToast("Enter a valid stake", "bad");
  if (stake < MIN_STAKE)    return showToast(`Minimum bet is ${MIN_STAKE} pts`, "bad");
  if (stake > balance)      return showToast("Insufficient balance", "bad");
  const btn = document.getElementById("tradeBtn");
  btn.disabled = true; btn.innerText = "Placing...";
  try {
    const res  = await fetch(`${SUPA_URL}/functions/v1/place-trade`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData: tgInitData, market_id: activeMkt.id, choice, stake })
    });
    const data = await res.json();
    if (!res.ok) return showToast(data.error || "Trade failed", "bad");
    showToast("Trade placed! üéØ", "ok");
    closeModal();
    await loadBalance();
    await loadMarkets();
  } catch { showToast("Connection error", "bad"); }
  finally { btn.disabled = false; btn.innerText = "Confirm Trade"; }
}

async function loadBalance() {
  const { data } = await db.from("wallets").select("balance_points").eq("telegram_id", tgId).single();
  if (data) { balance = data.balance_points; updateBalUI(); }
}

// ‚îÄ‚îÄ PORTFOLIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadTrades() {
  const el = document.getElementById("tradeList");
  el.innerHTML = `<div class="spinner"></div>`;
  const { data } = await db.from("trades").select("*").eq("telegram_id", tgId)
    .order("created_at", { ascending: false }).limit(100);
  if (!data?.length) {
    el.innerHTML = `<div class="empty"><div class="ei">üìä</div><p>No trades yet.<br>Go place your first bet!</p></div>`;
    document.getElementById("stTotal").innerText = "0";
    document.getElementById("stWon").innerText   = "0";
    document.getElementById("stPts").innerText   = "0";
    return;
  }
  const won = data.filter(t => t.status === "won");
  const pts = won.reduce((s, t) => s + (t.payout_points || 0), 0);
  document.getElementById("stTotal").innerText = data.length;
  document.getElementById("stWon").innerText   = won.length;
  document.getElementById("stPts").innerText   = pts.toLocaleString();
  el.innerHTML = data.map(t => {
    const cls    = t.status === "won" ? "tp-won" : t.status === "lost" ? "tp-lost" : "tp-active";
    const payout = t.status === "won"  ? `+${t.payout_points?.toLocaleString()} pts`
                 : t.status === "lost" ? "Lost" : "Pending";
    const optCls = t.option === "YES" ? "tcb-yes" : "tcb-no";
    let oddsStr = "";
    if (t.status === "won" && t.payout_points && t.amount_points) {
      oddsStr = `<span style="font-size:11px;color:var(--muted);margin-left:6px">√ó${(t.payout_points/t.amount_points).toFixed(2)}</span>`;
    }
    return `<div class="trade-card">
      <div class="tc-q">${t.question || "Market"}</div>
      <div class="tc-row">
        <div class="tc-left">
          <span class="tc-badge ${optCls}">${t.option}</span>
          <span class="tc-stake">${t.amount_points?.toLocaleString()} pts${oddsStr}</span>
        </div>
        <div class="tc-payout ${cls}">${payout}</div>
      </div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProfile() {
  const { data } = await db.from("users")
    .select("username, full_name, email, membership_tier, referral_badge")
    .eq("telegram_id", tgId).single();
  if (!data) return;

  const name = data.full_name || data.username || data.email?.split("@")[0] || "Trader";
  document.getElementById("profAv").innerText    = name[0].toUpperCase();
  document.getElementById("profName").innerText  = name;
  document.getElementById("profEmail").innerText = data.email || "‚Äî";
  document.getElementById("profTgId").innerText  = tgId;

  // Show @username in gold below the name
  if (data.username) {
    document.getElementById("profUsername").innerText = "@" + data.username;
  }

  // Show referral badge if they earned one (recruiter / connector / influencer / legend)
  const badgeNames = {
    recruiter:  "ü•â Recruiter",
    connector:  "ü•à Connector",
    influencer: "ü•á Influencer",
    legend:     "üíé Legend"
  };
  if (data.referral_badge && badgeNames[data.referral_badge]) {
    document.getElementById("profBadge").innerText        = badgeNames[data.referral_badge];
    document.getElementById("profBadgeWrap").style.display = "block";
  }

  const tier = data.membership_tier || "free";
  const tb   = document.getElementById("profTier");
  tb.innerText = tier.charAt(0).toUpperCase() + tier.slice(1);
  tb.className = `tier-badge tb-${tier}`;
}

// ‚îÄ‚îÄ REFERRALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Loads data for the referrals page
async function loadReferrals() {
  // Get the user's own referral code from the database
  const { data: user } = await db.from("users")
    .select("referral_code, referral_badge")
    .eq("telegram_id", tgId).single();

  if (user?.referral_code) {
    document.getElementById("refCode").innerText = user.referral_code;
  }

  // Get all referral records where this user is the referrer
  // (i.e. people who signed up using their code)
  const { data: refs } = await db.from("referrals")
    .select("*")
    .eq("referrer_id", tgId)
    .order("created_at", { ascending: false });

  const all       = refs || [];
  const completed = all.filter(r => r.status === "completed"); // friend placed a trade
  const earned    = completed.length * 100; // 100 pts per completed referral

  document.getElementById("refTotal").innerText  = all.length;       // total signups with code
  document.getElementById("refActive").innerText = completed.length; // actually placed a trade
  document.getElementById("refEarned").innerText = earned;           // points earned

  // Render badge progress bars
  // Like video game achievements ‚Äî unlock badges as you refer more people
  const badges = [
    { slug: "recruiter",  emoji: "ü•â", name: "Recruiter",  need: 1,  color: "#cd7f32" },
    { slug: "connector",  emoji: "ü•à", name: "Connector",  need: 5,  color: "#c0c0c0" },
    { slug: "influencer", emoji: "ü•á", name: "Influencer", need: 10, color: "#f0c040" },
    { slug: "legend",     emoji: "üíé", name: "Legend",     need: 50, color: "#a855f7" },
  ];

  const count        = completed.length; // how many completed referrals
  const currentBadge = user?.referral_badge;

  document.getElementById("badgeWrap").innerHTML = badges.map(b => {
    const done  = count >= b.need;
    const pct   = Math.min(100, Math.floor((count / b.need) * 100));
    const isCur = currentBadge === b.slug;
    return `<div class="badge-row">
      <div class="badge-top">
        <span class="badge-name" style="color:${done ? b.color : 'var(--muted)'}">
          ${b.emoji} ${b.name}${isCur ? ' <span style="font-size:10px;color:var(--muted);font-weight:400">(current)</span>' : ''}
        </span>
        <span class="badge-req">${Math.min(count, b.need)}/${b.need}</span>
      </div>
      <div class="badge-bar">
        <div class="badge-fill" style="width:${pct}%;background:${done ? b.color : 'var(--blue)'}"></div>
      </div>
    </div>`;
  }).join("");

  // ‚îÄ‚îÄ PER-PERSON LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Shows every single person who used your referral code, with:
  //   - their username (or telegram ID if no username)
  //   - when they signed up
  //   - whether they have placed a trade yet (= "active")
  //   - whether YOU received your 100 pts reward for them
  const listEl = document.getElementById("refPeopleList");
  if (!all.length) {
    listEl.innerHTML = `<div class="empty" style="padding:16px 0"><div class="ei">üë•</div><p>Nobody has used your code yet.<br>Share it with friends!</p></div>`;
  } else {
    listEl.innerHTML = all.map(r => {
      // Work out display name ‚Äî referrals table stores referee_id (their telegram id)
      // We show their username if we have it, otherwise show a masked telegram ID
      const name     = r.referee_username ? "@" + r.referee_username : "User " + String(r.referee_id).slice(-4);
      const joinDate = new Date(r.created_at).toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
      const isActive = r.status === "completed"; // they placed their first trade
      // Did YOU get your reward yet?
      const rewardReceived = r.referrer_rewarded === true;

      return `<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div style="font-size:14px;font-weight:700;margin-bottom:3px">${name}</div>
          <div style="font-size:11px;color:var(--muted)">Joined ${joinDate}</div>
          <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
            <!-- Has the friend placed a trade? -->
            <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;
              background:${isActive ? 'rgba(0,229,122,.1)' : 'rgba(72,80,112,.15)'};
              color:${isActive ? 'var(--green)' : 'var(--muted)'}">
              ${isActive ? "‚úÖ Active" : "‚è≥ Not traded yet"}
            </span>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <!-- Did the referrer (you) get your 100 pts bonus? -->
          ${rewardReceived
            ? `<div style="font-size:13px;font-weight:800;color:var(--gold)">+100 pts</div>
               <div style="font-size:10px;color:var(--muted);margin-top:2px">Reward received ‚úì</div>`
            : isActive
              ? `<div style="font-size:13px;font-weight:800;color:var(--gold)">+100 pts</div>
                 <div style="font-size:10px;color:var(--muted);margin-top:2px">Processing...</div>`
              : `<div style="font-size:13px;font-weight:700;color:var(--muted)">+100 pts</div>
                 <div style="font-size:10px;color:var(--muted);margin-top:2px">Pending trade</div>`}
        </div>
      </div>`;
    }).join("");
  }
}

// Opens the Telegram share sheet with a pre-written message containing the referral code
function shareReferral() {
  const code = document.getElementById("refCode").innerText;
  if (code === "‚Äî") return showToast("Code loading, try again...", "bad");

  const msg = `üéØ Join me on Cassino Trade!\n\nPredict real-world events and win points.\n\nUse my referral code *${code}* when you sign up ‚Äî we BOTH get 100 pts free when you place your first trade!\n\nt.me/options_trading_cassino_bot`;

  if (window.Telegram?.WebApp) {
    // Opens Telegram's native share sheet with the message pre-filled
    window.Telegram.WebApp.openTelegramLink(
      `https://t.me/share/url?url=https://t.me/options_trading_cassino_bot&text=${encodeURIComponent(msg)}`
    );
  } else {
    // Fallback: copy to clipboard if not inside Telegram
    navigator.clipboard?.writeText(msg).then(() => showToast("Copied to clipboard!", "ok"));
  }
}

// ‚îÄ‚îÄ DEPOSIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openDeposit() {
  const euros = prompt(`Deposit amount in EUR (minimum ‚Ç¨${MIN_DEPOSIT}, ‚Ç¨1 = 10 pts):`);
  if (euros === null) return; // user pressed cancel
  const amount = Number(euros);
  if (!euros || isNaN(amount) || amount < MIN_DEPOSIT) {
    return showToast(`Minimum deposit is ‚Ç¨${MIN_DEPOSIT}`, "bad");
  }
  showToast("Opening Stripe...", "ok");
  try {
    const res  = await fetch(`${SUPA_URL}/functions/v1/create-checkout`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount, initData: tgInitData })
    });
    const data = await res.json();
    if (data.url) window.Telegram?.WebApp?.openLink(data.url) || (window.location.href = data.url);
    else showToast(data.error || "Checkout failed", "bad");
  } catch { showToast("Connection error", "bad"); }
}

// ‚îÄ‚îÄ SUBMIT QUESTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSubmit() {
  const q   = document.getElementById("sqQ").value.trim();
  const ctx = document.getElementById("sqCtx").value.trim();
  setErr("sqErr", "");
  if (q.length < 10) return setErr("sqErr", "Question must be at least 10 characters.");
  if (balance < 100) return setErr("sqErr", "You need at least 100 pts to submit.");
  const btn = document.getElementById("sqBtn");
  btn.disabled = true; btn.innerText = "Submitting...";
  try {
    const res  = await fetch(`${SUPA_URL}/functions/v1/submit-question`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData: tgInitData, question: q, context: ctx })
    });
    const data = await res.json();
    if (!res.ok) return setErr("sqErr", data.error || "Submission failed.");
    showToast("Submitted! We'll review within 24h üôå", "ok");
    document.getElementById("sqQ").value     = "";
    document.getElementById("sqCtx").value   = "";
    document.getElementById("sqC").innerText = "0/200";
    await loadBalance();
    await loadSubmissions();
  } catch { setErr("sqErr", "Connection error."); }
  finally { btn.disabled = false; btn.innerText = "Submit ¬∑ 100 pts"; }
}

async function loadSubmissions() {
  const el = document.getElementById("subList");
  const { data } = await db.from("question_submissions")
    .select("*").eq("telegram_id", tgId)
    .order("created_at", { ascending: false });
  if (!data?.length) {
    el.innerHTML = `<div class="empty" style="padding:24px 0"><div class="ei">üìù</div><p>No submissions yet</p></div>`;
    return;
  }
  el.innerHTML = data.map(s => `
    <div class="sub-item">
      <div class="sub-q">${s.question}</div>
      <div class="sub-foot">
        <span class="ss-${s.status}">${s.status}</span>
        <span class="sub-pts">${s.refunded ? "100 pts refunded" : "100 pts charged"}</span>
      </div>
    </div>`).join("");
}

// ‚îÄ‚îÄ MEMBERSHIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSubscribe(slug) {
  showToast("Prices coming soon ‚Äî stay tuned!", "bad");
}

// ‚îÄ‚îÄ WITHDRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function wdCalc() {
  const pts = parseInt(document.getElementById("wdAmt").value) || 0;
  document.getElementById("wdHint").innerText = `‚âà ‚Ç¨${(pts / PTS_PER_EUR).toFixed(2)}`;
}

async function doWithdraw() {
  const pts  = parseInt(document.getElementById("wdAmt").value);
  const iban = document.getElementById("wdIban").value.trim().replace(/\s+/g, "");
  setErr("wdErr", "");
  if (!pts || pts < MIN_WITHDRAW) return setErr("wdErr", `Minimum withdrawal is ${MIN_WITHDRAW} pts (‚Ç¨${MIN_WITHDRAW / PTS_PER_EUR}).`);
  if (!iban)                       return setErr("wdErr", "Please enter your IBAN.");
  if (pts > balance)               return setErr("wdErr", "Insufficient balance.");
  const btn = document.querySelector("#vWithdraw .btn-gold");
  btn.disabled = true; btn.innerText = "Submitting...";
  try {
    // Deduct points immediately
    const newBalance = balance - pts;
    const { error: balErr } = await _db.from("wallets")
      .update({ balance_points: newBalance }).eq("telegram_id", tgId);
    if (balErr) return setErr("wdErr", "Failed to lock funds. Please try again.");
    balance = newBalance;
    updateBalUI();
    // Insert withdrawal request
    const { error: wdErr } = await _db.from("withdrawals").insert({
      telegram_id:   tgId,
      amount_eur:    parseFloat((pts / PTS_PER_EUR).toFixed(2)),
      amount_points: pts,
      iban,
      status:        "pending"
    });
    if (wdErr) {
      // Rollback if insert failed
      await _db.from("wallets").update({ balance_points: balance + pts }).eq("telegram_id", tgId);
      balance = balance + pts;
      updateBalUI();
      return setErr("wdErr", "Failed to submit withdrawal. Your points have been returned.");
    }
    // Write to ledger
    await _db.rpc("write_ledger", {
      p_telegram_id:  tgId,
      p_amount:       -pts,
      p_type:         "withdrawal_request",
      p_reference_id: null,
      p_note:         `Withdrawal request: ${pts} pts (‚Ç¨${(pts / PTS_PER_EUR).toFixed(2)})`
    });
    showToast("Withdrawal requested ‚úÖ 2‚Äì5 business days", "ok");
    document.getElementById("wdAmt").value      = "";
    document.getElementById("wdIban").value     = "";
    document.getElementById("wdHint").innerText = "‚âà ‚Ç¨0.00";
    goBack();
  } catch (err) {
    console.error("Withdrawal error:", err);
    setErr("wdErr", "Connection error. Try again.");
  } finally {
    btn.disabled = false; btn.innerText = "Request Withdrawal";
  }
}

// ‚îÄ‚îÄ HISTORY (deposits + withdrawals) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Tracks which tab is active: "dep" or "wd"
let histMode = "dep";

// Called when user taps Deposits / Withdrawals tab
function histTab(mode) {
  histMode = mode;
  // Highlight the active tab button
  document.getElementById("htDep").classList.toggle("on", mode === "dep");
  document.getElementById("htWd").classList.toggle("on",  mode === "wd");
  loadHistory(mode);
}

// Loads the actual data and renders cards
async function loadHistory(mode) {
  histMode = mode;
  const el = document.getElementById("histList");
  el.innerHTML = `<div class="spinner"></div>`;

  if (mode === "dep") {
    // ‚îÄ‚îÄ DEPOSITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Pull from the payments table ‚Äî each row is a Stripe deposit
    const { data, error } = await db
      .from("payments")
      .select("amount_eur, amount_points, status, created_at, stripe_session_id")
      .eq("telegram_id", tgId)
      .order("created_at", { ascending: false })
      .limit(100);

    if (error || !data?.length) {
      el.innerHTML = `<div class="empty"><div class="ei">üí≥</div><p>No deposits yet.<br>Tap Deposit to add points!</p></div>`;
      return;
    }

    el.innerHTML = data.map(p => {
      // Status colour ‚Äî green = completed, yellow = pending, red = failed
      const sClass = p.status === "completed" ? "hs-completed"
                   : p.status === "pending"   ? "hs-pending"
                   : "hs-rejected";
      const date = new Date(p.created_at).toLocaleDateString("en-GB", {
        day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit"
      });
      return `<div class="hist-card">
        <div class="hist-left">
          <div class="hist-type">üí≥ Stripe Deposit</div>
          <div class="hist-date">${date}</div>
        </div>
        <div class="hist-right">
          <div class="hist-amt" style="color:var(--gold)">+${Number(p.amount_points).toLocaleString()} pts</div>
          <div class="hist-eur">‚Ç¨${Number(p.amount_eur).toFixed(2)}</div>
          <div class="hist-status ${sClass}">${p.status}</div>
        </div>
      </div>`;
    }).join("");

  } else {
    // ‚îÄ‚îÄ WITHDRAWALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Pull from the withdrawals table
    const { data, error } = await db
      .from("withdrawals")
      .select("amount_eur, amount_points, iban, status, created_at, admin_note")
      .eq("telegram_id", tgId)
      .order("created_at", { ascending: false })
      .limit(100);

    if (error || !data?.length) {
      el.innerHTML = `<div class="empty"><div class="ei">üè¶</div><p>No withdrawals yet.<br>Win some trades first!</p></div>`;
      return;
    }

    el.innerHTML = data.map(w => {
      // Status colour
      const sClass = w.status === "completed"  ? "hs-completed"
                   : w.status === "processing" ? "hs-processing"
                   : w.status === "pending"    ? "hs-pending"
                   : "hs-rejected";
      const date = new Date(w.created_at).toLocaleDateString("en-GB", {
        day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit"
      });
      // Shorten IBAN for display: show first 8 + *** + last 4
      const iban = w.iban
        ? w.iban.replace(/\s/g, "").replace(/(.{8}).*(.{4})$/, "$1‚Ä¢‚Ä¢‚Ä¢$2")
        : "‚Äî";
      return `<div class="hist-card">
        <div class="hist-left">
          <div class="hist-type">üè¶ Bank Withdrawal</div>
          <div class="hist-date">${date}</div>
          <div class="hist-iban">${iban}</div>
          ${w.admin_note ? `<div style="font-size:11px;color:var(--muted);margin-top:2px">${w.admin_note}</div>` : ""}
        </div>
        <div class="hist-right">
          <div class="hist-amt" style="color:var(--red)">‚àí${Number(w.amount_points).toLocaleString()} pts</div>
          <div class="hist-eur">‚Ç¨${Number(w.amount_eur).toFixed(2)}</div>
          <div class="hist-status ${sClass}">${w.status}</div>
        </div>
      </div>`;
    }).join("");
  }
}

// ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Shows a small popup message at the bottom of the screen
function showToast(msg, type = "ok") {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.className = `show ${type}`;
  clearTimeout(t._t);
  t._t = setTimeout(() => t.className = "", 3000);
}
</script>
</body>
</html>
